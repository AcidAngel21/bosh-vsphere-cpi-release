#!/usr/bin/env sh

set -e -x

BOSH_PACKAGES_DIR=${BOSH_PACKAGES_DIR:-/var/vcap/packages}

mkdir -p ${BOSH_INSTALL_TARGET}/{bin,gem_home}

export PATH=$BOSH_PACKAGES_DIR/gem_home/bin:$PATH
export PATH=$BOSH_PACKAGES_DIR/vsphere_cpi_ruby/bin:$PATH

source $BOSH_PACKAGES_DIR/gem_home/share/gem_home/gem_home.sh
pushd ${BOSH_INSTALL_TARGET}/gem_home

gem_home .
popd

cd vsphere_cpi

cat >> Gemfile <<EOF
gem 'bosh_vsphere_cpi'
EOF

# force bundler to use a clean config
export BUNDLE_CONFIG=`pwd`/.cpi_bundle_config

bundle install \
  --local           \
  --no-prune        \
  --binstubs ${BOSH_INSTALL_TARGET}/bin

cp Gemfile ${BOSH_INSTALL_TARGET}
cp Gemfile.lock ${BOSH_INSTALL_TARGET}
