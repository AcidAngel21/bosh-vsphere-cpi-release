$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), 'lib'))

require 'ci/rake'

require 'open3'
require 'time'
require 'shellwords'

require 'ci/pipeline'
require 'ci/pool'
require 'ci/target'

DOCKER_NAME = ENV.fetch('DOCKER_NAME', 'vcpici/vcpi-main')

namespace :docker do
  desc 'Build a docker image from the Dockerfile'
  task(:make) { sh 'docker', 'build', '-t', DOCKER_NAME, 'docker' }

  desc "Push the docker image to '#{DOCKER_NAME}'"
  task(:push) { sh 'docker', 'push', DOCKER_NAME }

  desc "Pull the docker image from '#{DOCKER_NAME}'"
  task(:pull) { sh 'docker', 'pull', DOCKER_NAME }
end

desc "Pull, build, and push the docker image '#{DOCKER_NAME}'"
task docker: %w[docker:pull docker:make docker:push]

file 'pipeline.yml' => FileList['pipeline/*.yml.erb'] do |t|
  pipeline = Pipeline.new

  pipeline.pool('5.5') do |pool|
    pool.params = {
      RSPEC_FLAGS: "--tag ~replicate_stemcell_two_threads --tag ~vsan_datastore --tag ~nsx_vsphere --tag ~nsx_transformers --tag ~log_creds",
      NSXT_SKIP_SSL_VERIFY: "true"
    }
  end

  pipeline.pool('6.0') do |pool|
    pool.params = {
      RSPEC_FLAGS: "--tag ~nsx_vsphere --tag ~nsxt_version_two",
      NSXT_SKIP_SSL_VERIFY: "true"
    }
  end

  pipeline.pool('6.0-NSXV') do |pool|
    pool.params = {
      RSPEC_FLAGS: "--tag nsx_vsphere",
      NSXT_SKIP_SSL_VERIFY: "true"
    }
  end

  pipeline.pool('6.5') do |pool|
    pool.params = {
      RSPEC_FLAGS: "--tag ~nsx_vsphere --tag ~disk_migration",
      NSXT_SKIP_SSL_VERIFY: "true"
    }
  end

  pipeline.pool('6.5-NSXV') do |pool|
    pool.params = {
      RSPEC_FLAGS: "--tag nsx_vsphere",
      NSXT_SKIP_SSL_VERIFY: "true"
    }
  end

  pipeline.pool('6.7') do |pool|
    pool.params = {
      RSPEC_FLAGS: "--tag ~nsx_vsphere --tag ~nsx_transformers --tag ~disk_migration",
    }
  end

  File.write(t.name, pipeline.render)
end

desc 'Create or update the pipeline configuration'
task :pipeline, [:name] => 'pipeline.yml' do |t, args|
  # Default to the unexpired target expiring furthest in the future known to
  # `fly`
  CONCOURSE = ENV.fetch('CONCOURSE') do
    authorized = Target.list.select { |t| t.expiry > Time.now }
    unless target = authorized.max_by(&:expiry)
      fail 'No Concourse target specified and all targets are expired'
    end
    target.name
  end

  # Ensure that the remote host is set from DBCHOST
  DBCHOST = ENV.fetch('DBCHOST') do
    fail 'DBCHOST must be set to the unqualified hostname of your DBC host'
  end
  dbcfqdn = "#{DBCHOST}.eng.vmware.com"

  # Get the remote user name from DBCUSER, the SSH configuration for DBCHOST, or
  # the current user name
  DBCUSER = ENV.fetch('DBCUSER') do
    output, _, status = Open3.capture3('ssh', '-G', dbcfqdn)
    break nil unless status.success?
    record = output.each_line(chomp: true).map do |text|
      text.split(nil, 2)
    end.find { |option, _| option == 'user' }
    break record[1] unless record.nil?
  end || (require 'etc'; Etc.getpwuid.name)

  # Find the SSH identity file to use from the SSH configuration for DBCHOST
  output, _, status = Open3.capture3('ssh', '-G', dbcfqdn)
  fail "Unable to get SSH configuration for #{DBCHOST}" unless status.success?
  dbc_ssh_key = output.each_line(chomp: true).map do |text|
    text.split(nil, 2)
  end.find do |option, v|
    option == 'identityfile' && File.exist?(File.expand_path(v))
  end or fail "No SSH identity file available for #{DBCHOST}"
  dbc_ssh_key = File.expand_path(dbc_ssh_key[1])

  # Get the git branch name
  branch = ENV.fetch('BRANCH') { `git symbolic-ref -q --short HEAD`.strip }

  # Set the pipeline name to be vSphere-CPI when on the master branch or
  # vSphere-CPI-#{branch} when on another branch. If the branch name is
  # indeterminate (because HEAD is detached) then the pipeline name must be
  # provided as the name argument to this task.
  args.with_defaults(name: ENV.fetch('PIPELINE') do
    if branch.empty?
      fail 'Pipeline name must be specified if HEAD is detached'
    end
    branch == 'master' ? 'vSphere-CPI' : "vcpi-#{branch}"
  end)

  # Default to master if the branch name is indeterminate (because HEAD is
  # detached).
  branch = !branch.empty? ? branch : 'master'

  sh '/bin/bash', '-ec', [
    "fly -t #{CONCOURSE.shellescape} set-pipeline",
    "-p #{args.name.shellescape}",
    "-c #{t.prerequisites.first.shellescape}",
    "-v vcpi_branch=#{branch.shellescape}",
    "-v dbc_host=#{DBCHOST.shellescape}",
    "-v dbc_user=#{DBCUSER.shellescape}",
    "-v dbc_key=\"$(cat #{dbc_ssh_key.shellescape})\"",
    '-v s3_vsphere_cpi_bucket=bosh-vsphere-cpi-release',
    '-l <(secret show ~/.dot/vcpi-ci.gpg)'
  ].join(' ')
end

task default: :pipeline
